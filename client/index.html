<!doctype html>
<html>
  <head>
    <title>Stream file</title>
    <meta charset="utf-8">
    <script src="binary.js"></script>
	<script src="openpgp.js"></script>
  </head>
  <body style="background-size:cover">
	<p>Open this page in another browser window and start sending files.</p>
	<div><input type="file" id="fileinput" capture="camera"/></div>
	<div id="log"><div>

    <script>
    var client = new BinaryClient('ws://localhost:5000');

	var openpgp = window.openpgp
	var message = window.openpgp.message

	var div = document.getElementById('log');

	var privkey, pubkey, sendKey;

	var options = {
    numBits: 2048,
    userId: 'Jon Smith <jon.smith@example.org>',
    passphrase: 'super long and hard to guess secret',
	unlocked: true
	};

	openpgp.generateKeyPair(options).then(function(keypair) {
		// success
		/*
		privkey = keypair.key;
		console.log(privkey);
		*/
		privkey = openpgp.key.readArmored(keypair.privateKeyArmored).keys[0];
		privkey.decrypt('super long and hard to guess secret');
		pubkey = keypair.publicKeyArmored;
		data = new Blob([pubkey], {type : 'plain/text'});
		client.send(data, "sendPubKey");
	}).catch(function(error) {
		// failure
	});

    client.on('stream', function(stream, metadat) {
      var parts = [];
      var meta = metadat;
      stream.on('data', function(data) {
        parts.push(data);
      });

      stream.on('end', function() {
		if (meta == "pubKey" || meta == "sendPubKey") {
			var reader = new FileReader();
			reader.readAsText(new Blob(parts, {type: "plain/text"}));
			reader.onload = function(event) {
				var contents = event.target.result;
				sendKey = openpgp.key.readArmored(contents);
				log("received public key");
			};
			if (meta == "sendPubKey") {
				var data = new Blob([pubkey], {type : 'plain/text'});
				client.send(data, "pubKey");
			}
		} else {
			var reader = new FileReader();
			reader.readAsText(new Blob(parts, {type : 'plain/text'}));
			reader.onload = function(event) {
				log("received file");
				var msg = openpgp.message.readArmored(event.target.result);
				msg = msg.decrypt(privkey);
				log("len: " + msg.getLiteralData().length);
				log(msg.getLiteralData().slice(0,50));

				var data = new Blob([str2ab(msg.getLiteralData())], {type : 'application/octet-stream'});
				var url = (window.URL || window.webkitURL).createObjectURL(data);
				var a = document.createElement("a");
				a.href = url;
				a.text = meta;
				a.download = meta;
				document.body.appendChild(a);
				document.body.appendChild(document.createElement("br"));
			};
		}
      });
    });


	function str2ab(str) {
	  var buf = new ArrayBuffer(str.length); // 2 bytes for each char
	  var bufView = new Uint8Array(buf);
	  for (var i=0, strLen=str.length; i<strLen; i++) {
		bufView[i] = str.charCodeAt(i);
	  }
	  return buf;
	}

	function log(str) {
		div.innerHTML = div.innerHTML + str + "<br />";
	}

    fileinput.addEventListener('change', function(event) {
		var file = event.target.files[0];
		var name = event.target.value.split(/(\\|\/)/g).pop()
		var reader = new FileReader();

		reader.onloadend = function () {
			console.log("len: " + reader.result.length);
			console.log(reader.result.slice(0,50));
			var msg = openpgp.message.fromBinary(reader.result);
			msg = msg.encrypt(sendKey.keys);
			data = new Blob([msg.armor()], {type : 'plain/text'});
			client.send(data, name);
			log("sent file");
		}

		reader.readAsBinaryString(file);

    }, false);
    </script>

  </body>
</html>
